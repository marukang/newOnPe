/**-------------------------------------------------------------------------------------------------
 *										확대축소 플러그인 스크립트
 *																					Date	: 2015.12.07
 *																					Author	: 박정민
 **/
eBookCore.plugins.zoomview={ratio:0,origSize:{width:0,height:0},close:function(o,e){},run:function(o){},setInOut:function(o,e){},rePosition:function(){},setPagePos:function(){}}
var _currentZoomPage=1,zoomEl
eBookCore.plugins.zoomview.close=function(o,e){eBookCore.func.gotoPage(_currentZoomPage),eBookCore.plugins.zoomview.loadPage(o,e,_currentZoomPage),$(window).off(".zoomview"),$(".zoomview").detach()},eBookCore.plugins.zoomview.run=function(o){if(o){eBookCore.plugins.zoomview.close(),zoomEl=$("<div class='zoomview'/>").html("<div class='blind' /><img class='loading' src='"+eBookCore.path.pageview+"loading_zoom.gif' /><span class='zoomviewRatio'>0%</span>").on("mousewheel",function(o){eBookCore.plugins.zoomview.setInOut(o.deltaY,.1)}).on("pinching",function(o,e){eBookCore.plugins.zoomview.setInOut(e.distance,.001*Math.pow(Math.abs(e.distance),1.1))}).on("click touchstart drag",function(o){$(".zoomview .zoomviewBtn").stop().css({opacity:1}).doTimeout(2e3,function(){this.stop().animate({opacity:.2},1e3)})}),zoomEl.appendTo(document.body)
var e=.1*window.innerWidth,i=.1*window.innerHeight,t=eBookCore.path.skin+eBookSkin.path.image+"zoomview/"
zoomEl.append("<img class='zoomviewBtn' id='zoomviewClose'\tsrc='"+t+"close.png' tabindex='0' alt='"+eBookCore.getString("close")+"' /><img class='zoomviewBtn' id='zoomviewIn' \t\tsrc='"+t+"zoomin.png' tabindex='0' alt='"+eBookCore.getString("zoomIn")+"' /><img class='zoomviewBtn' id='zoomviewOut'\t\tsrc='"+t+"zoomout.png' tabindex='0' alt='"+eBookCore.getString("zoomOut")+"' /><img class='zoomviewBtn' id='zoomviewPrev' style='width:"+e+"px; height:"+i+"px'\t\tsrc='"+t+"prev.svg' tabindex='0' alt='"+eBookCore.getString("prev_page")+"' /><img class='zoomviewBtn' id='zoomviewNext' style='width:"+e+"px; height:"+i+"px'\t\tsrc='"+t+"next.svg' tabindex='0' alt='"+eBookCore.getString("next_page")+"' />"),$("#zoomviewClose").on(eBookCore.eventType.keyclick,function(o){eBookCore.eventType.isExcute(o)&&eBookCore.plugins.zoomview.close()}),$("#zoomviewIn").on(eBookCore.eventType.keyclick,function(o){eBookCore.eventType.isExcute(o)&&eBookCore.plugins.zoomview.setInOut(1,.2)}),$("#zoomviewOut").on(eBookCore.eventType.keyclick,function(o){eBookCore.eventType.isExcute(o)&&eBookCore.plugins.zoomview.setInOut(-1,.2)}),$("#zoomviewPrev").on(eBookCore.eventType.keyclick,function(e){eBookCore.eventType.isExcute(e)&&eBookCore.plugins.zoomview.gotoPrev(o,zoomEl)}),$("#zoomviewNext").on(eBookCore.eventType.keyclick,function(e){eBookCore.eventType.isExcute(e)&&eBookCore.plugins.zoomview.gotoNext(o,zoomEl)}),_currentZoomPage=parseInt(o.closest("[page]").attr("page")),eBookCore.plugins.zoomview.loadPage(o,zoomEl,_currentZoomPage)}},eBookCore.plugins.zoomview.rePosition=function(){var o=$(".zoomview img.target"),e=croTools.getClientSize(),i=e.height*eBookCore.thumbRatio>e.width
o.css({width:i?e.width:e.height*eBookCore.thumbRatio,height:i?e.width*(1/eBookCore.thumbRatio):e.height}),o.css({left:(e.width-o.width())/2,top:(e.height-o.height())/2}),eBookCore.plugins.zoomview.ratio=o.width()/eBookCore.plugins.zoomview.origSize.width,$(".zoomviewRatio").text(parseInt(100*eBookCore.plugins.zoomview.ratio)+"%")},eBookCore.plugins.zoomview.setInOut=function(o,e){eBookCore.plugins.zoomview.ratio=0<o?Math.min(10,eBookCore.plugins.zoomview.ratio+e):Math.max(.01,eBookCore.plugins.zoomview.ratio-e)
var i=$(".zoomview img.target"),t=croTools.getClientSize()
if(0>o&&t.width>i.width()&&t.height>i.height())return eBookCore.plugins.zoomview.close()
var n=i.offset(),r={x:t.width/2,y:t.height/2},g={x:(n.left-r.x)/i.width(),y:(n.top-r.y)/i.height()}
i.css({width:eBookCore.plugins.zoomview.origSize.width*eBookCore.plugins.zoomview.ratio,height:eBookCore.plugins.zoomview.origSize.height*eBookCore.plugins.zoomview.ratio}),$(".zoomviewRatio").text(parseInt(100*eBookCore.plugins.zoomview.ratio)+"%").stop().css({opacity:1}).doTimeout(1e3,function(){this.stop().animate({opacity:0},1e3)}),i.css({left:r.x+i.width()*g.x,top:r.y+i.height()*g.y}),eBookCore.plugins.zoomview.setPagePos()},eBookCore.plugins.zoomview.setPagePos=function(){var o=$(".zoomview img.target")
if(o.length){var e=croTools.getClientSize(),i=o.offset()
o.css({left:croTools.rangeValue(i.left,o.width()<e.width?0:e.width-o.width(),o.width()>e.width?0:e.width-o.width()),top:croTools.rangeValue(i.top,o.height()<e.height?0:e.height-o.height(),o.height()>e.height?0:e.height-o.height())})}},eBookCore.plugins.zoomview.loadPage=function(o,e,i){var t=(eBookCore.currentPageNum,i.toString()+""),n=eBookCore.path.pages+t+"."+eBookData.pageExt,r=n.substr(0,n.lastIndexOf("."))+".svg",g=$(croTools.canHTML5()?"<img class='target' src='"+r+"' />":"<img class='target' src='"+n+"' />")
g.on("error",function(){g.attr("src",n)}).load(function(){e.find("img.loading").detach(),e.append(g),setTimeout(function(){eBookCore.plugins.zoomview.origSize={width:g.width(),height:g.height()},eBookCore.plugins.zoomview.rePosition()},croTools.isMSIE()?100:0)}).on(eBookCore.eventType.dblclick,eBookCore.plugins.zoomview.close).draggable({stop:eBookCore.plugins.zoomview.setPagePos}),$(".zoomview .zoomviewBtn").animate({opacity:1},1e3).doTimeout(2e3,function(){this.stop().animate({opacity:.2},1e3)}),$(".zoomviewRatio").animate({opacity:1},1e3,function(){$(".zoomviewRatio").doTimeout(2e3,function(){this.animate({opacity:0},1e3)})}),$(window).on("resize.zoomview",eBookCore.plugins.zoomview.rePosition)},eBookCore.plugins.zoomview.gotoFistPage=function(o,e){_currentZoomPage=1,eBookCore.plugins.zoomview.loadPage(o,e,_currentZoomPage)},eBookCore.plugins.zoomview.gotoPrev=function(o,e){_currentZoomPage>1?(_currentZoomPage-=1,eBookCore.plugins.zoomview.loadPage(o,e,_currentZoomPage)):eBookCore.func.showFlashPopup(eBookCore.getString("first_page"))},eBookCore.plugins.zoomview.gotoNext=function(o,e){_currentZoomPage<eBookData.totalPageNum?(_currentZoomPage+=1,eBookCore.plugins.zoomview.loadPage(o,e,_currentZoomPage)):eBookCore.func.showFlashPopup(eBookCore.getString("last_page"))},eBookCore.plugins.zoomview.gotoLastPage=function(o,e){_currentZoomPage=eBookData.totalPageNum,eBookCore.plugins.zoomview.loadPage(o,e,_currentZoomPage)}
