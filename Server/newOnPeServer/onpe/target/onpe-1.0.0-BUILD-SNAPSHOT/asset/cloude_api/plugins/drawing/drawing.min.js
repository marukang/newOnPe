/**-------------------------------------------------------------------------------------------------
 *										판서 플러그인 스크립트( sketch.min.js 사용 )
 *																					Date	: 2015.05.04
 *																					Author	: 박정민
 **/
eBookCore.plugins.drawing={drawingData:{},colors:["rgba(238,96,132,1.0)","rgba(255,242,115,1.0)","rgba(200,255,188,1.0)","rgba(0,190,195,1.0)","rgba(182,228,255,1.0)","rgba(143,150,255,1.0)","rgba(0,0,0,1.0)","rgba(255,255,255,1.0)"],colorKeys:["Q","W","E","R","A","S","D","F"],sizes:[3,6,9,12,15],sizeKeys:["1","2","3","4","5"],redos:{count:0,data:[]},options:{toolLinks:!0,defaultTool:"marker",defaultColor:"rgba(238,96,132,1.0)",defaultSize:9},opacity:1,run:function(o){},resizeCanvas:function(){},eventKeyup:function(o){}},eBookCore.plugins.drawing.resizeCanvas=function(){var o=$("#ebookdrawingCanvas")
o.length&&(o.width()===window.innerWidth&&o.height()===window.innerHeight||(o.attr({width:window.innerWidth,height:window.innerHeight}),o.sketch().redraw()))},eBookCore.plugins.drawing.run=function(o){if(0<$("#ebookdrawing").length)return $("#ebookdrawing").detach()
var e=$("<div id='ebookdrawing'>").html("<div class='blind'>")
$.cookie.json=!0
e.appendTo(document.body),$('<canvas id="ebookdrawingCanvas" width="'+window.innerWidth+'" height="'+window.innerHeight+'" >').css("opacity",eBookCore.plugins.drawing.opacity).on("mouseup",function(o){var e=$(this).sketch(),n=eBookCore.plugins.drawing.redos
0<n.data.length&&n.count!==n.data.length+e.actions.length&&(n.data=[],n.count=e.actions.length),$("#drawingmenubar .drawingBtns.undo").css("opacity",0<e.actions.length?1:""),$("#drawingmenubar .drawingBtns.redo").css("opacity",0<n.data.length?1:"")}).appendTo(e)
var n=$("<div id='ebookdrawingTools'>")
n.appendTo(e),n.css({left:.5*(window.innerWidth-n.outerWidth()),top:window.innerHeight-n.outerHeight()})
var a=$("<div id='drawingcolors'  class='drawingToolSub' />"),r=$("<div id='drawingsizes'   class='drawingToolSub' />"),i=$("<div id='drawingmenubar' class='drawingToolSub ' />")
n.append(a).append(r).append(i),a.append("<span class='category'>COLORS</span>"),$.each(eBookCore.plugins.drawing.colors,function(o,e){a.append($("<a class='drawingColors' data-color='"+this+"' style='background:"+this+";"+(e===eBookCore.plugins.drawing.options.defaultColor?"opacity:1;":"")+" '></a> ").on(eBookCore.eventType.click,function(o){var e=$(this)
e.parent().children().css("opacity",""),e.css("opacity","1"),eBookCore.plugins.drawing.options.defaultColor=e.attr("data-color"),r.find("a").css("background",eBookCore.plugins.drawing.options.defaultColor),$("#ebookdrawingCanvas").sketch().color=e.attr("data-color")}))}),croTools.isMobile()||$("a.drawingColors").each(function(o,e){$("<span>"+eBookCore.plugins.drawing.colorKeys[o]+"</span>").appendTo(e).on(eBookCore.eventType.click,function(){$(e).trigger(eBookCore.eventType.click)})}),r.append("<span class='category'>SIZES</span>"),$.each(eBookCore.plugins.drawing.sizes,function(o,e){r.append($("<a class='drawingSizes' data-size='"+this+"' style='height:"+this+"px;"+(e===eBookCore.plugins.drawing.options.defaultSize?"opacity:1;":"")+" background:"+eBookCore.plugins.drawing.options.defaultColor+"; '></a>").on(eBookCore.eventType.click,function(o){var e=$(this)
eBookCore.plugins.drawing.options.defaultSize=parseInt(e.attr("data-size")),e.parent().children().css("opacity",""),e.css("opacity","1"),$("#ebookdrawingCanvas").sketch().size=e.attr("data-size")}))}),croTools.isMobile()||$("a.drawingSizes").each(function(o,e){$("<span style='font-size:"+eBookCore.plugins.drawing.sizes[o]+"px'>"+(o+1)+"</span>").appendTo(e).on(eBookCore.eventType.click,function(){$(e).trigger(eBookCore.eventType.click)})}),i.append($('<img class="drawingBtns opacity" src="'+eBookCore.resource.pen+'" title="'+eBookCore.getString("pen")+'(P)" />').on(eBookCore.eventType.click,function(o){var e=$("#drawingcolors .drawingColors"),n=-1<e.eq(0).attr("data-color").indexOf("1.0")
e.each(function(o,e){e=$(e)
var a=e.attr("data-color")
e.attr("data-color",a.replace(n?"1.0":"0.5",n?"0.5":"1.0"))}),$("#ebookdrawingCanvas").sketch().color=$("#ebookdrawingCanvas").sketch().color.replace(n?"1.0":"0.5",n?"0.5":"1.0"),o.target.src=n?eBookCore.resource.marker:eBookCore.resource.pen,o.target.title=n?eBookCore.getString("marker"):eBookCore.getString("pen")})),i.append($('<img class="drawingBtns opacity" src="'+eBookCore.resource.layer+'" title="'+eBookCore.getString("opacity")+'(SHIFT)" />').on(eBookCore.eventType.click,function(){var o=$("#ebookdrawingCanvas"),e=parseFloat(o.css("opacity"))-.25
eBookCore.plugins.drawing.opacity=0<e?e:1,o.css("opacity",eBookCore.plugins.drawing.opacity)})),i.append($('<img class="drawingBtns undo" src="'+eBookCore.resource.undo+'" title="'+eBookCore.getString("undo")+'(Z)" />').on(eBookCore.eventType.click,function(){var o=$("#ebookdrawingCanvas").sketch()
if(1>o.actions.length)return void $("#drawingmenubar .drawingBtns.undo").css("opacity","")
var e=eBookCore.plugins.drawing.redos
0<e.data.length&&e.count!==e.data.length+o.actions.length&&(e.data=[]),e.data.push(o.actions.pop()),e.count=e.data.length+o.actions.length,o.redraw(),$("#drawingmenubar .drawingBtns.undo").css("opacity",o.actions.length?1:""),$("#drawingmenubar .drawingBtns.redo").css("opacity",e.data.length?1:"")})),i.append($('<img class="drawingBtns redo" src="'+eBookCore.resource.redo+'" title="'+eBookCore.getString("redo")+'(X)" />').on(eBookCore.eventType.click,function(){var o=$("#ebookdrawingCanvas").sketch(),e=eBookCore.plugins.drawing.redos
if(!(1>e.data.length)){if(0<e.data.length&&e.count!==e.data.length+o.actions.length)return e.data=[],e.count=o.actions.length,void $("#drawingmenubar .drawingBtns.redo").css("opacity","")
o.actions.push(e.data.pop()),o.redraw(),$("#drawingmenubar .drawingBtns.undo").css("opacity",o.actions.length?1:""),$("#drawingmenubar .drawingBtns.redo").css("opacity",e.data.length?1:"")}})),i.append($('<img class="drawingBtns clear" src="'+eBookCore.resource.blank+'" title="'+eBookCore.getString("clear")+'(C)"/>').on(eBookCore.eventType.click,function(){$("#ebookdrawingCanvas").detach().clone().prependTo(e).sketch(eBookCore.plugins.drawing.options),eBookCore.plugins.drawing.redos.data=[],eBookCore.plugins.drawing.redos.count=0,$("#drawingmenubar .drawingBtns.undo, #drawingmenubar .drawingBtns.redo").css("opacity","")})),i.append($('<img class="drawingBtns download" src="'+eBookCore.resource.download+'" title="'+eBookCore.getString("download")+'(V)"></img>').on(eBookCore.eventType.click,function(){$("#ebookdrawingCanvas")[0].toBlob(function(e){saveAs(e,"drawing_p"+o+".png")})})),i.append($('<img class="drawingBtns close" src="'+eBookCore.resource.close+'" title="'+eBookCore.getString("close")+'(ESC)"/>').on(eBookCore.eventType.click,function(){var e={},n=$("#ebookdrawingCanvas").sketch().actions
0<n.length?(eBookCore.plugins.drawing.drawingData[o]=JSON.stringify(n),e[o]=JSON.stringify(n)):(eBookCore.plugins.drawing.drawingData[o]=null,e[o]=null),e=eBookCore.plugins.drawing.drawingData,console.log(JSON.stringify(eBookCore.plugins.drawing.drawingData)),console.log(JSON.stringify(e)),"undefined"!=typeof localStorage&&(localStorage.ebookdrawing=JSON.stringify(e)),$(window).off(".drawing"),$("#ebookdrawing").detach()})),n.draggable({opacity:.9,cancel:".drawingBtns, .drawingColors, .drawingSizes"}),$(".drawingColors, .drawingSizes, .drawingBtns").on("dragstart",function(o){o.preventDefault()})
var t=$("#ebookdrawingCanvas")
if(t.sketch(eBookCore.plugins.drawing.options),"undefined"!=typeof localStorage){var s=localStorage.getItem("ebookdrawing"),d={}
if(s&&(d=JSON.parse(s),console.log("_drawingData >> "+JSON.stringify(d[o]))),d[o]){var g=JSON.parse(d[o])
console.log("AAAAAA"+JSON.stringify(d[o])),console.log("BBBBBB"+JSON.stringify(g)),eBookCore.plugins.drawing.drawingData[o]=JSON.stringify(g)}}eBookCore.plugins.drawing.drawingData[o]&&(t.sketch().actions=JSON.parse(eBookCore.plugins.drawing.drawingData[o]),t.sketch().redraw(),$("#drawingmenubar .drawingBtns.undo").css("opacity",1))
var c=t.sketch().actions
eBookCore.plugins.drawing.redos={count:c?c.length:0,data:[]},$(window).on("keyup.drawing",eBookCore.plugins.drawing.eventKeyup).on("resize.drawing",eBookCore.plugins.drawing.resizeCanvas),$(document.activeElement).blur()},eBookCore.plugins.drawing.eventKeyup=function(o){for(var e=croTools.keyCode,n=$("#drawingcolors .drawingColors"),a=[e.Q,e.W,e.E,e.R,e.A,e.S,e.D,e.F],r=0;r<a.length;++r)if(o.which===a[r])return void n.eq(r).trigger("click")
for(var i=$("#drawingsizes .drawingSizes"),t=[e[1],e[2],e[3],e[4],e[5]],r=0;r<t.length;++r)if(o.which===t[r])return void i.eq(r).trigger("click")
for(var s=$("#drawingmenubar img"),d=[e.SHIFT,e.Z,e.X,e.C,e.V,e.ESC],r=0;r<d.length;++r)if(o.which===d[r])return void s.eq(r).trigger("click")}
